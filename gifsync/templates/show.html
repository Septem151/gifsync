{% extends "skeleton.html" %}
{% block styles %}
    <!-- Link the css file specifically for this page -->
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static', filename='css/show.css') }}">
{% endblock styles %}
{% block content %}
    <img id="synced-image" class="synced-image mx-auto d-block"
         src="">
    <div class="row justify-content-center">
        <p class="header my-auto">Sync another?</p>
        <a class="col-auto ml-3 my-3 btn btn-custom-green shadow-none" type="button"
           href="{{ url_for('create') }}">
            Click here!
        </a>
    </div>
    <div class="row justify-content-center mb-4">
        <p class="header my-auto">Not satisfied?</p>
        <a class="col-auto ml-3 my-3 btn btn-custom-red shadow-none" type="button"
           href="{{ url_for('api_delete_gif', id=gif_id) }}">
            Delete gif
        </a>
    </div>
{% endblock content %}
{% block js %}
    <script>
        var timeout = 30000;
        var curr_song = 'placeholdersong';
        var base_synced_gif_url = {{ url_for('api_synced_gif', gif_id=gif_id)|tojson }}

        function updateLoop() {
            $.ajax({
                method: 'GET',
                url: {{ url_for('api_curr_song')|tojson }}
            }).done(updateSong);
        }

        function updateSong(data) {
            if('paused' in data) {
                timeout = 30000;
                if(curr_song !== 'placeholdersong') {
                    curr_song = 'placeholdersong';
                    updateGif();
                }
            } else {
                time_remaining = parseInt(data['remaining_ms']);
                if (time_remaining < 30000) {
                    timeout = time_remaining;
                } else {
                    timeout = 30000;
                }
                song_id = data['id'];
                if(curr_song !== song_id) {
                    curr_song = song_id;
                    updateGif();
                }
            }
            setTimeout(updateLoop, timeout);
        }

        function updateGif() {
            image_url = base_synced_gif_url;
            if(curr_song !== 'placeholdersong') {
                image_url += ('&song_id=' + curr_song);
            }
            image_url += '#' + new Date().getTime()
            $('#synced-image').attr('src', image_url);
        }

        updateLoop();
    </script>
    <script>
        $(window).on('unload', function(e) {

        });
    </script>
{% endblock js %}
